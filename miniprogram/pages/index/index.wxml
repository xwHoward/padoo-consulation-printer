<navigation-bar title="" back="{{false}}" color="black" background="#FFF">
  <view slot="left" class="nav-btns">
    <view bindtap="goToHome" class="nav-btn" aria-role="button" aria-label="主页">
      <text class="nav-btn-text">主页</text>
    </view>
    <view bindtap="onRefresh" class="nav-btn" aria-role="button" aria-label="刷新">
      <text class="nav-btn-text">刷新</text>
    </view>
    <view bindtap="onScreensaver" class="nav-btn" aria-role="button" aria-label="无人值守">
      <text class="nav-btn-text">无人值守</text>
    </view>
  </view>
  <view slot="right" class="nav-btns">
    <view bindtap="goToCashier" class="nav-btn" aria-role="button" aria-label="场控收银">
      <text class="nav-btn-text">场控收银</text>
    </view>
    <view bindtap="goToHistory" class="nav-btn" aria-role="button" aria-label="单据">
      <text class="nav-btn-text">单据</text>
    </view>
  </view>
</navigation-bar>
<scroll-view class="scrollarea" scroll-y type="list">
  <view class="container">
    <view class="section">
      <!-- Logo -->
      <view class="logo-container">
        <image class="logo" src="/assets/logo.jpg" mode="contain" />
      </view>
      <!-- 双人模式切换 -->
      <view class="dual-mode-switch" wx:if="{{!editId}}">
        <view class="dual-mode-label">双人模式</view>
        <switch class="dual-mode-toggle" checked="{{isDualMode}}" bindchange="toggleDualMode" color="#FF6B00" />
      </view>
      <!-- 双人模式顾客切换标签 -->
      <view class="guest-tabs" wx:if="{{isDualMode}}">
        <view class="guest-tab {{activeGuest === 1 ? 'active' : ''}}" bindtap="switchGuest" data-guest="1">
          <view class="tab-text">顾客1</view>
          <view class="guest-name" wx:if="{{guest1Info.surname}}">
            {{guest1Info.surname}}{{guest1Info.gender === 'male' ? '先生' : '女士'}}
          </view>
          <view class="guest-tech" wx:if="{{guest1Info.technician}}">
            {{guest1Info.technician}}
          </view>
        </view>
        <view class="guest-tab {{activeGuest === 2 ? 'active' : ''}}" bindtap="switchGuest" data-guest="2">
          <view class="tab-text">顾客2</view>
          <view class="guest-name" wx:if="{{guest2Info.surname}}">
            {{guest2Info.surname}}{{guest2Info.gender === 'male' ? '先生' : '女士'}}
          </view>
          <view class="guest-tech" wx:if="{{guest2Info.technician}}">
            {{guest2Info.technician}}
          </view>
        </view>
      </view>
      <view class="form-item">
        <view class="form-label">项目</view>
        <project-selector selectedProject="{{(isDualMode ? (activeGuest === 1 ? guest1Info.project : guest2Info.project) : consultationInfo.project)}}" bind:change="onProjectSelect" />
      </view>
      <!-- 加强部位 -->
      <view class="section-title">加强部位</view>
      <body-selector selectedParts="{{isDualMode ? (activeGuest === 1 ? guest1Info.selectedParts : guest2Info.selectedParts) : consultationInfo.selectedParts}}" bind:change="onBodyPartSelect" />
    </view>
    <!-- 按摩力度 -->
    <view class="section">
      <view class="section-title">按摩力度</view>
      <strength-selector selectedStrength="{{(isDualMode ? (activeGuest === 1 ? guest1Info.massageStrength : guest2Info.massageStrength) : consultationInfo.massageStrength)}}" bind:change="onMassageStrengthSelect" />
    </view>
    <!-- 精油选择 -->
    <view class="section" wx:if="{{!currentProjectIsEssentialOilOnly}}">
      <view class="section-title">精油选择</view>
      <oil-selector selectedOil="{{isDualMode ? (activeGuest === 1 ? guest1Info.essentialOil : guest2Info.essentialOil) : consultationInfo.essentialOil}}" bind:change="onEssentialOilSelect" />
    </view>
    <!-- 专属精油显示 -->
    <view class="section" wx:if="{{currentProjectIsEssentialOilOnly}}">
      <view class="section-title">专属精油</view>
      <image class="exclusive-oil-image" src="/assets/essential-oil.jpg" mode="aspectFill" />
    </view>
    <!-- 升级选项 -->
    <view class="section">
      <view class="section-title">升级选项</view>
      <view class="checkbox-group">
        <label class="checkbox-item upgrade-option {{(isDualMode ? (activeGuest === 1 ? guest1Info.upgradeHimalayanSaltStone : guest2Info.upgradeHimalayanSaltStone) : consultationInfo.upgradeHimalayanSaltStone) ? 'selected' : ''}}" bindtap="onUpgradeSelect">
          <view class="upgrade-checkbox"></view>
          <image class="upgrade-bg" src="/assets/saltstone.jpg" mode="aspectFill" />
          <image class="upgrade-bg-qr" src="/assets/qr.jpg" mode="aspectFill" />
          <view class="upgrade-mask"></view>
          <view class="upgrade-gradient-mask"></view>
        </label>
      </view>
    </view>
    <!-- 免费停车区域 -->
    <view class="section">
      <view class="section-title">免费停车</view>
      <view class="parking-form">
        <view class="form-item" style="flex-wrap: wrap;">
          <text class="form-label">车牌号</text>
          <view class="plate-input-container" bindtap="showPlateInputModal">
            <view class="plate-inputs">
              <view class="plate-input {{isNoPlate && index === 0 ? 'fixed' : ''}}" wx:for="{{plateNumber}}" wx:key="index">
                {{item || ''}}
              </view>
            </view>
          </view>
          <view class="parking-tips">*免费停车2小时，超时需要自付超额部分，1元/小时</view>
        </view>
      </view>
    </view>
    <!-- 上钟信息 -->
    <view class="section">
      <view class="section-title">上钟信息</view>
      <view class="form-item">
        <text class="form-label">技师</text>
        <technician-selector selectedTechnician="{{(isDualMode ? (activeGuest === 1 ? guest1Info.technician : guest2Info.technician) : consultationInfo.technician)}}" technicianList="{{technicianList}}" bind:change="onTechnicianSelect" />
        <view class="checkbox-group">
          <label class="checkbox-item {{(isDualMode ? (activeGuest === 1 ? guest1Info.isClockIn : guest2Info.isClockIn) : consultationInfo.isClockIn) ? 'selected' : ''}}" bindtap="onClockInSelect">
            点
          </label>
        </view>
      </view>
      <view class="form-item {{isDualMode && activeGuest === 2 ? 'shared-field-disabled' : ''}}">
        <text class="form-label">房间{{isDualMode ? '（共享）' : ''}}</text>
        <room-selector selectedRoom="{{consultationInfo.room}}" disabled="{{isDualMode && activeGuest === 2}}" bind:change="onRoomSelect" />
      </view>
    </view>
    <!-- 备注信息 -->
    <view class="section">
      <view class="section-title">其他</view>
      <!-- 个人信息（合并一行） -->
      <view wx:if="{{!matchedCustomerApplied}}" class="form-item combined-form-item customer-info-row">
        <view class="form-field surname-field">
          <text class="form-label">姓氏</text>
          <input class="form-input" placeholder="选填" bind:input="onSurnameInput" value="{{isDualMode ? (activeGuest === 1 ? guest1Info.surname : guest2Info.surname) : consultationInfo.surname}}" />
        </view>
        <view class="form-field gender-field">
          <gender-selector selectedGender="{{(isDualMode ? (activeGuest === 1 ? guest1Info.gender : guest2Info.gender) : consultationInfo.gender)}}" bind:change="onGenderSelect" />
        </view>
        <view class="form-field phone-field {{isDualMode && activeGuest === 2 ? 'shared-field-disabled' : ''}}">
          <text class="form-label">手机号{{isDualMode ? '（共享）' : ''}}</text>
          <input class="form-input" type="number" placeholder="选填" maxlength="11" bind:input="onPhoneInput" value="{{consultationInfo.phone}}" disabled="{{isDualMode && activeGuest === 2}}" />
        </view>
      </view>
      <!-- 顾客匹配结果 -->
      <view class="customer-match-result" wx:if="{{matchedCustomer}}">
        <view class="match-info">
          <view class="match-label">匹配顾客：</view>
          <view class="match-name">
            {{matchedCustomer.name}}{{matchedCustomer.gender === 'male' ? '先生' : '女士'}}
          </view>
          <view class="match-phone">{{matchedCustomer.phone || '无手机号'}}</view>
          <view class="match-tech" wx:if="{{matchedCustomer.responsibleTechnician}}">
            责任技师：{{matchedCustomer.responsibleTechnician}}
          </view>
          <view wx:if="{{matchedCustomer.remark}}" class="match-remark">
            {{matchedCustomer.remark}}
          </view>
          <view class="match-actions">
            <view wx:if="{{!matchedCustomerApplied}}" class="match-btn apply-btn" bindtap="applyMatchedCustomer">
              应用
            </view>
            <view class="match-btn clear-btn" bindtap="clearMatchedCustomer">清除</view>
          </view>
        </view>
      </view>
      <!-- 券码 -->
      <view class="form-item coupon-form-item">
        <text class="form-label">券码</text>
        <view class="coupon-container">
          <input class="form-input coupon-input" type="number" placeholder="选填" bind:input="onCouponCodeInput" value="{{isDualMode ? (activeGuest === 1 ? guest1Info.couponCode : guest2Info.couponCode) : consultationInfo.couponCode}}" />
        </view>
        <platform-selector selectedPlatform="{{(isDualMode ? (activeGuest === 1 ? guest1Info.couponPlatform : guest2Info.couponPlatform) : consultationInfo.couponPlatform)}}" bind:change="onCouponPlatformSelect" />
      </view>
      <view class="form-item">
        <text class="form-label">备注</text>
        <input class="form-input" placeholder="选填" bind:input="onRemarksInput" value="{{isDualMode ? (activeGuest === 1 ? guest1Info.remarks : guest2Info.remarks) : consultationInfo.remarks}}" />
      </view>
    </view>
    <!-- 提交和打印按钮 -->
    <view class="button-container" wx:if="{{!editId}}">
      <button class="primary-button" bindtap="printConsultation">打印</button>
      <button class="primary-button" bindtap="onClockIn">报钟</button>
    </view>
    <!-- 编辑模式按钮 -->
    <view class="button-container" wx:if="{{editId}}">
      <button class="primary-button" bindtap="printConsultation">打印</button>
      <button class="primary-button" bindtap="onClockIn">报钟</button>
      <button class="primary-button secondary-button" bindtap="cancelEdit">取消</button>
    </view>
  </view>
</scroll-view>
<!-- loading遮罩 -->
<view class="loading-mask" wx:if="{{loading}}">
  <view class="loading-spinner"></view>
  <view class="loading-text">{{loadingText}}</view>
</view>
<!-- 时间选择器弹窗 -->
<view class="modal-mask" wx:if="{{timePickerModal.show}}" bindtap="onTimePickerCancel"></view>
<view class="time-picker-modal" wx:if="{{timePickerModal.show}}">
  <view class="modal-header">
    <text class="modal-title">选择上钟开始时间</text>
    <text class="modal-close" bindtap="onTimePickerCancel">✕</text>
  </view>
  <view class="modal-body">
    <picker mode="multiSelector" range="{{[hours, minutes]}}" value="{{[selectedHour, selectedMinute]}}" bindchange="onTimePickerChange" bindcolumnchange="onTimeColumnChange">
      <view class="time-picker-display">
        <text class="time-value">{{timePickerModal.currentTime}}</text>
        <text class="time-hint">点击修改时间</text>
      </view>
    </picker>
  </view>
  <view class="modal-footer">
    <button class="modal-btn cancel-btn" bindtap="onTimePickerCancel">取消</button>
    <button class="modal-btn confirm-btn" bindtap="onTimePickerConfirm">确认</button>
  </view>
</view>
<!-- 车牌号输入弹窗 -->
<license-plate-input visible="{{licensePlateInputVisible}}" value="{{licensePlate}}" bind:cancel="hidePlateInputModal" bind:confirm="onPlateConfirm" />