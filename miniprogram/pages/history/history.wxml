<!-- history.wxml -->
<navigation-bar title="{{customerPhone ? '顾客咨询单' : '咨询单历史'}}" back="{{true}}" color="black" background="#FFF"></navigation-bar>
<scroll-view class="scrollarea" scroll-y type="list">
  <view class="container">
    <!-- 历史记录列表 -->
    <view class="history-list">
      <!-- 按天分组的历史记录 -->
      <block wx:if="{{historyData.length > 0}}">
        <view wx:for="{{historyData}}" wx:for-item="group" wx:key="date" class="daily-group">
          <view class="daily-header">
            <view class="date-header">{{group.date}}</view>
            <view class="summary-btn" bindtap="onGenerateSummary" data-date="{{group.date}}" wx:if="{{!customerPhone}}">
              总结
            </view>
          </view>
          <!-- 当日咨询单列表 -->
          <view class="consultation-list">
            <view wx:for="{{group.records}}" wx:for-item="record" wx:for-index="recordIndex" wx:key="id" class="consultation-item {{record.isVoided ? 'voided' : ''}} {{record.collapsed ? 'collapsed' : ''}}">
              <!-- 咨询单头部（始终显示） -->
              <view class="consultation-header" bindtap="toggleCollapse" data-group-index="{{index}}" data-record-index="{{recordIndex}}">
                <view class="consultation-basic">
                  <text class="customer-info">
                    {{group.records.length - recordIndex}}. {{record.surname}}{{record.gender === 'male' ? '先生' : '女士'}}
                  </text>
                  <text class="tag">{{record.room}}</text>
                  <text class="tag">{{record.endTime}}</text>
                  <text wx:if="{{record.isVoided}}" class="voided-tag">已作废</text>
                </view>
                <view class="collapse-btn">
                  <text class="collapse-icon">{{record.collapsed ? '▼' : '▲'}}</text>
                </view>
              </view>
              <!-- 咨询单详情（可折叠） -->
              <view class="consultation-body" wx:if="{{!record.collapsed}}">
                <view class="consultation-details" bindtap="showConsultationDetail" data-record="{{record}}">
                  <view class="consultation-meta">
                    <view class="text-info">
                      {{record.technician}}{{record.dailyCount && !record.isVoided ? '(' + record.dailyCount + ')' : ''}}{{record.isClockIn ? '[点]' : ''}}
                    </view>
                    <view class="text-info">{{record.project}}</view>
                    <view class="text-info">{{record.startTime}} - {{record.endTime}}</view>
                    <view wx:if="{{record.phone}}" class="text-info">{{record.phone}}</view>
                    <view class="text-info" wx:if="{{!record.isVoided}}">
                      加班{{record.overtime ? '(' + record.overtime + ')' : '(0)'}}
                    </view>
                    <view wx:if="{{record.couponPlatform}}" class="text-info">
                      {{platforms[record.couponPlatform]}} {{record.couponCode}}
                    </view>
                  </view>
                </view>
                <!-- 操作按钮 -->
                <view class="consultation-actions" wx:if="{{!customerPhone}}">
                  <button class="action-btn edit-btn" bindtap="editConsultation" data-record="{{record}}">
                    修改
                  </button>
                  <button class="action-btn extra-btn" bindtap="onExtraTime" data-record="{{record}}" data-date="{{group.date}}" wx:if="{{!record.isVoided}}">
                    加钟{{record.extraTime ? '(' + record.extraTime + ')' : ''}}
                  </button>
                  <button class="action-btn void-btn" bindtap="voidConsultation" data-record="{{record}}" data-date="{{group.date}}" wx:if="{{!record.isVoided}}">
                    作废
                  </button>
                </view>
              </view>
            </view>
          </view>
        </view>
      </block>
      <!-- 无记录提示 -->
      <view wx:else class="empty-hint">暂无咨询单历史记录</view>
    </view>
  </view>
</scroll-view>
<!-- 数字输入弹窗 -->
<view class="modal-mask" wx:if="{{numberInputModal.show}}" bindtap="onModalCancel"></view>
<view class="modal-container" wx:if="{{numberInputModal.show}}">
  <view class="modal-title">设置{{numberInputModal.title}}数</view>
  <view class="modal-content">
    <view class="number-input-wrapper">
      <view class="step-btn minus-btn {{numberInputModal.inputValue <= 0 ? 'disabled' : ''}}" bindtap="onStepMinus">
        <text>-</text>
      </view>
      <input class="number-input" type="number" value="{{numberInputModal.inputValue}}" bindinput="onNumberInput" />
      <view class="step-btn plus-btn" bindtap="onStepPlus">
        <text>+</text>
      </view>
    </view>
    <view class="modal-unit">单位：半小时</view>
  </view>
  <view class="modal-footer">
    <view class="modal-btn cancel-btn" bindtap="onModalCancel">取消</view>
    <view class="modal-btn confirm-btn" bindtap="onModalConfirm">确定</view>
  </view>
</view>