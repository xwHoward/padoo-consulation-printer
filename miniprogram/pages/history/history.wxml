<!-- history.wxml -->
<wxs src="./format.wxs" module="format" />
<navigation-bar title="{{customerPhone ? '顾客咨询单' : '咨询单纪录'}}" back="{{true}}" color="black" background="#FFF">
  <view slot="right" class="nav-right">
    <date-picker wx:if="{{!customerPhone}}" initialDate="{{dateSelector.selectedDate}}" bind:change="onDatePickerChange" />
  </view>
</navigation-bar>
<scroll-view class="scrollarea" scroll-y type="list">
  <view class="container">
    <!-- 历史记录列表 -->
    <view class="history-list">
      <!-- 按天分组的历史记录 -->
      <block wx:if="{{historyData.length > 0}}">
        <view wx:for="{{historyData}}" wx:for-item="group" wx:key="date" class="daily-group">
          <view class="daily-header">
            <view class="date-header">{{group.date}}</view>
            <view class="summary-btn" bindtap="onGenerateSummary" data-date="{{group.date}}" wx:if="{{!customerPhone}}">
              总结
            </view>
          </view>
          <!-- 当日咨询单列表 -->
          <view class="consultation-list">
            <view wx:for="{{group.records}}" wx:for-item="record" wx:for-index="recordIndex" wx:key="_id" class="consultation-item {{record.isVoided ? 'voided' : ''}} {{record.collapsed ? 'collapsed' : ''}}">
              <!-- 咨询单头部（始终显示） -->
              <view class="consultation-header" bindtap="toggleCollapse" data-group-index="{{index}}" data-record-index="{{recordIndex}}">
                <view class="consultation-basic">
                  <text class="customer-info">
                    {{group.records.length - recordIndex}}. {{record.surname}}{{genders[record.gender] || ''}}
                  </text>
                  <text class="tag">{{record.room}}</text>
                  <text class="tag">{{record.endTime}}</text>
                  <text wx:if="{{record.isVoided}}" class="voided-tag">已作废</text>
                </view>
                <view class="collapse-btn">
                  <text class="collapse-icon">{{record.collapsed ? '▼' : '▲'}}</text>
                </view>
              </view>
              <!-- 咨询单详情（可折叠） -->
              <view class="consultation-body" wx:if="{{!record.collapsed}}">
                <view class="consultation-details" bindtap="showConsultationDetail" data-record="{{record}}">
                  <view class="consultation-meta">
                    <view class="text-info">
                      {{record.technician}}{{record.dailyCount && !record.isVoided ? '(' + record.dailyCount + ')' : ''}}{{record.isClockIn ? '[点]' : ''}}
                    </view>
                    <view class="text-info">{{record.project}}</view>
                    <view class="text-info">{{record.startTime}} - {{record.endTime}}</view>
                    <view wx:if="{{record.phone}}" class="text-info">{{record.phone}}</view>
                    <view class="text-info" wx:if="{{!record.isVoided}}">
                      加班{{record.overtime ? '(' + record.overtime + ')' : '(0)'}}
                    </view>
                    <view wx:if="{{record.couponPlatform}}" class="text-info">
                      {{platforms[record.couponPlatform]}} {{record.couponCode}}
                    </view>
                  </view>
                </view>
                <!-- 结算信息 -->
                <view class="settlement-info" wx:if="{{record.settlement}}">
                  <view class="settlement-header">
                    <view class="settlement-label">✓ 已结算</view>
                    <view class="settlement-time">
                      {{format.formatSettlementTime(record.settlement.settledAt)}}
                    </view>
                  </view>
                  <view class="settlement-amount">实收总额：¥{{record.settlement.totalAmount}}</view>
                  <view class="payment-list">
                    <view class="payment-item" wx:for="{{record.settlement.payments}}" wx:key="method" wx:for-item="payment">
                      <view class="payment-platform">
                        {{paymentPlatformLabels[payment.method]}}
                      </view>
                      <view class="payment-detail">
                        <text wx:if="{{payment.method === 'membership'}}">{{payment.amount}}次</text>
                        <text wx:else>¥{{payment.amount}}</text>
                      </view>
                      <view class="payment-coupon" wx:if="{{payment.couponCode}}">
                        券码：{{payment.couponCode}}
                      </view>
                    </view>
                  </view>
                </view>
                <!-- 操作按钮 -->
                <view class="consultation-actions" wx:if="{{!customerPhone}}">
                  <button class="action-btn edit-btn" bindtap="editConsultation" data-record="{{record}}">
                    修改
                  </button>
                  <button class="action-btn early-finish-btn" bindtap="onEarlyFinish" data-record="{{record}}" wx:if="{{record.isInProgress && !record.isVoided}}">
                    提前下钟
                  </button>
                  <button class="action-btn extra-btn" bindtap="onExtraTime" data-record="{{record}}" data-date="{{group.date}}" wx:if="{{!record.isVoided}}">
                    加钟{{record.extraTime ? '(' + record.extraTime + ')' : ''}}
                  </button>
                  <button class="action-btn void-btn" bindtap="voidConsultation" data-record="{{record}}" data-date="{{group.date}}" wx:if="{{!record.isVoided}}">
                    作废
                  </button>
                  <button class="action-btn delete-btn" bindtap="deleteConsultation" data-record="{{record}}" data-date="{{group.date}}" wx:if="{{canDelete}}">
                    删除
                  </button>
                </view>
              </view>
            </view>
          </view>
        </view>
      </block>
      <!-- 无记录提示 -->
      <view wx:else class="empty-hint">暂无咨询单历史记录</view>
    </view>
  </view>
</scroll-view>
<!-- 数字输入弹窗 -->
<view class="modal-mask" wx:if="{{numberInputModal.show}}" bindtap="onModalCancel"></view>
<view class="modal-container" wx:if="{{numberInputModal.show}}">
  <view class="modal-title">设置{{numberInputModal.title}}数</view>
  <view class="modal-content">
    <view class="number-input-wrapper">
      <view class="step-btn minus-btn {{numberInputModal.inputValue <= 0 ? 'disabled' : ''}}" bindtap="onStepMinus">
        <text>-</text>
      </view>
      <input class="number-input" type="number" value="{{numberInputModal.inputValue}}" bindinput="onNumberInput" />
      <view class="step-btn plus-btn" bindtap="onStepPlus">
        <text>+</text>
      </view>
    </view>
    <view class="modal-unit">单位：半小时</view>
  </view>
  <view class="modal-footer">
    <view class="modal-btn cancel-btn" bindtap="onModalCancel">取消</view>
    <view class="modal-btn confirm-btn" bindtap="onModalConfirm">确定</view>
  </view>
</view>
  <!-- 提前下钟确认弹窗 -->
<view class="modal-mask" wx:if="{{earlyFinishModal.show}}" bindtap="onEarlyFinishModalCancel"></view>
<view class="modal-container" wx:if="{{earlyFinishModal.show}}">
  <view class="modal-title">提前下钟</view>
  <view class="modal-body">
    <view class="early-finish-info">
      <view class="info-row">
        <view class="info-label">技师：</view>
        <view class="info-value">{{earlyFinishModal.technician}}</view>
      </view>
      <view class="info-row">
        <view class="info-label">房间：</view>
        <view class="info-value">{{earlyFinishModal.room}}</view>
      </view>
      <view class="info-row">
        <view class="info-label">操作：</view>
        <view class="info-value">将结束时间更新为当前时间</view>
      </view>
    </view>
  </view>
  <view class="modal-footer">
    <view class="modal-btn cancel-btn" bindtap="onEarlyFinishModalCancel">取消</view>
    <view class="modal-btn confirm-btn" bindtap="onEarlyFinishModalConfirm">确定</view>
  </view>
</view>
<!-- loading遮罩 -->
<view class="loading-mask" wx:if="{{loading}}">
  <view class="loading-spinner"></view>
  <view class="loading-text">{{loadingText}}</view>
</view>
<!-- 每日总结推送确认弹窗 -->
<view class="modal-mask" wx:if="{{summaryModal.show}}" bindtap="onSummaryModalCancel"></view>
<view class="summary-modal" wx:if="{{summaryModal.show}}">
  <view class="modal-header">
    <text class="modal-title">确认每日总结</text>
    <text class="modal-close" bindtap="onSummaryModalCancel">✕</text>
  </view>
  <view class="modal-body">
    <textarea class="summary-textarea" value="{{summaryModal.content}}" bindinput="onSummaryContentInput" placeholder="请输入每日总结内容" maxlength="2000" auto-height show-confirm-bar="{{false}}" />
    <text class="char-count">{{summaryModal.content.length}}/2000</text>
  </view>
  <view class="modal-footer">
    <button class="modal-btn cancel-btn" bindtap="onSummaryModalCancel">取消</button>
    <button class="modal-btn confirm-btn" bindtap="onSummaryModalConfirm" disabled="{{summaryModal.loading}}">
      {{summaryModal.loading ? '推送中...' : '确认推送'}}
    </button>
  </view>
</view>