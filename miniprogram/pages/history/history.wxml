<!-- history.wxml -->
<wxs src="./format.wxs" module="format" />
<navigation-bar title="{{customerPhone ? 'é¡¾å®¢å’¨è¯¢å•' : 'å’¨è¯¢å•å†å²'}}" back="{{true}}" color="black" background="#FFF">
  <view slot="right" class="nav-right">
    <view class="date-selector-btn" bindtap="showDateSelector" wx:if="{{!customerPhone}}">
      <text class="date-selector-icon">ğŸ“…</text>
      <text class="date-selector-text">{{dateSelector.selectedDate || 'é€‰æ‹©æ—¥æœŸ'}}</text>
    </view>
  </view>
</navigation-bar>
<scroll-view class="scrollarea" scroll-y type="list">
  <view class="container">
    <!-- å†å²è®°å½•åˆ—è¡¨ -->
    <view class="history-list">
      <!-- æŒ‰å¤©åˆ†ç»„çš„å†å²è®°å½• -->
      <block wx:if="{{historyData.length > 0}}">
        <view wx:for="{{historyData}}" wx:for-item="group" wx:key="date" class="daily-group">
          <view class="daily-header">
            <view class="date-header">{{group.date}}</view>
            <view class="summary-btn" bindtap="onGenerateSummary" data-date="{{group.date}}" wx:if="{{!customerPhone}}">
              æ€»ç»“
            </view>
          </view>
          <!-- å½“æ—¥å’¨è¯¢å•åˆ—è¡¨ -->
          <view class="consultation-list">
            <view wx:for="{{group.records}}" wx:for-item="record" wx:for-index="recordIndex" wx:key="id" class="consultation-item {{record.isVoided ? 'voided' : ''}} {{record.collapsed ? 'collapsed' : ''}}">
              <!-- å’¨è¯¢å•å¤´éƒ¨ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰ -->
              <view class="consultation-header" bindtap="toggleCollapse" data-group-index="{{index}}" data-record-index="{{recordIndex}}">
                <view class="consultation-basic">
                  <text class="customer-info">
                    {{group.records.length - recordIndex}}. {{record.surname}}{{genders[record.gender] || ''}}
                  </text>
                  <text class="tag">{{record.room}}</text>
                  <text class="tag">{{record.endTime}}</text>
                  <text wx:if="{{record.isVoided}}" class="voided-tag">å·²ä½œåºŸ</text>
                </view>
                <view class="collapse-btn">
                  <text class="collapse-icon">{{record.collapsed ? 'â–¼' : 'â–²'}}</text>
                </view>
              </view>
              <!-- å’¨è¯¢å•è¯¦æƒ…ï¼ˆå¯æŠ˜å ï¼‰ -->
              <view class="consultation-body" wx:if="{{!record.collapsed}}">
                <view class="consultation-details" bindtap="showConsultationDetail" data-record="{{record}}">
                  <view class="consultation-meta">
                    <view class="text-info">
                      {{record.technician}}{{record.dailyCount && !record.isVoided ? '(' + record.dailyCount + ')' : ''}}{{record.isClockIn ? '[ç‚¹]' : ''}}
                    </view>
                    <view class="text-info">{{record.project}}</view>
                    <view class="text-info">{{record.startTime}} - {{record.endTime}}</view>
                    <view wx:if="{{record.phone}}" class="text-info">{{record.phone}}</view>
                    <view class="text-info" wx:if="{{!record.isVoided}}">
                      åŠ ç­{{record.overtime ? '(' + record.overtime + ')' : '(0)'}}
                    </view>
                    <view wx:if="{{record.couponPlatform}}" class="text-info">
                      {{platforms[record.couponPlatform]}} {{record.couponCode}}
                    </view>
                  </view>
                </view>
                <!-- ç»“ç®—ä¿¡æ¯ -->
                <view class="settlement-info" wx:if="{{record.settlement}}">
                  <view class="settlement-header">
                    <view class="settlement-label">âœ“ å·²ç»“ç®—</view>
                    <view class="settlement-time">{{format.formatSettlementTime(record.settlement.settledAt)}}</view>
                  </view>
                  <view class="settlement-amount">
                    å®æ”¶æ€»é¢ï¼šÂ¥{{record.settlement.totalAmount}}
                  </view>
                  <view class="payment-list">
                    <view class="payment-item" wx:for="{{record.settlement.payments}}" wx:key="method" wx:for-item="payment">
                      <view class="payment-platform">{{paymentPlatformLabels[payment.method]}}</view>
                      <view class="payment-detail">
                        <text wx:if="{{payment.method === 'membership'}}">{{payment.amount}}æ¬¡</text>
                        <text wx:else>Â¥{{payment.amount}}</text>
                      </view>
                      <view class="payment-coupon" wx:if="{{payment.couponCode}}">
                        åˆ¸ç ï¼š{{payment.couponCode}}
                      </view>
                    </view>
                  </view>
                </view>
                <!-- æ“ä½œæŒ‰é’® -->
                <view class="consultation-actions" wx:if="{{!customerPhone}}">
                  <button class="action-btn edit-btn" bindtap="editConsultation" data-record="{{record}}">
                    ä¿®æ”¹
                  </button>
                  <button class="action-btn extra-btn" bindtap="onExtraTime" data-record="{{record}}" data-date="{{group.date}}" wx:if="{{!record.isVoided}}">
                    åŠ é’Ÿ{{record.extraTime ? '(' + record.extraTime + ')' : ''}}
                  </button>
                  <button class="action-btn void-btn" bindtap="voidConsultation" data-record="{{record}}" data-date="{{group.date}}" wx:if="{{!record.isVoided}}">
                    ä½œåºŸ
                  </button>
                </view>
              </view>
            </view>
          </view>
        </view>
      </block>
      <!-- æ— è®°å½•æç¤º -->
      <view wx:else class="empty-hint">æš‚æ— å’¨è¯¢å•å†å²è®°å½•</view>
    </view>
  </view>
</scroll-view>
<!-- loadingé®ç½© -->
<view class="loading-mask" wx:if="{{loading}}">
  <view class="loading-spinner"></view>
  <view class="loading-text">{{loadingText}}</view>
</view>
<!-- æ•°å­—è¾“å…¥å¼¹çª— -->
<view class="modal-mask" wx:if="{{numberInputModal.show}}" bindtap="onModalCancel"></view>
<view class="modal-container" wx:if="{{numberInputModal.show}}">
  <view class="modal-title">è®¾ç½®{{numberInputModal.title}}æ•°</view>
  <view class="modal-content">
    <view class="number-input-wrapper">
      <view class="step-btn minus-btn {{numberInputModal.inputValue <= 0 ? 'disabled' : ''}}" bindtap="onStepMinus">
        <text>-</text>
      </view>
      <input class="number-input" type="number" value="{{numberInputModal.inputValue}}" bindinput="onNumberInput" />
      <view class="step-btn plus-btn" bindtap="onStepPlus">
        <text>+</text>
      </view>
    </view>
    <view class="modal-unit">å•ä½ï¼šåŠå°æ—¶</view>
  </view>
  <view class="modal-footer">
    <view class="modal-btn cancel-btn" bindtap="onModalCancel">å–æ¶ˆ</view>
    <view class="modal-btn confirm-btn" bindtap="onModalConfirm">ç¡®å®š</view>
  </view>
</view>
<!-- æ—¥æœŸé€‰æ‹©å™¨å¼¹çª— -->
<view class="modal-mask" wx:if="{{dateSelector.show}}" bindtap="hideDateSelector"></view>
<view class="date-selector-container" wx:if="{{dateSelector.show}}">
  <view class="date-selector-header">
    <view class="date-selector-title">é€‰æ‹©æ—¥æœŸ</view>
    <view class="date-selector-close" bindtap="hideDateSelector">âœ•</view>
  </view>
  <scroll-view class="date-selector-list" scroll-y>
    <view class="date-item {{dateSelector.selectedDate === item ? 'selected' : ''}}" 
          wx:for="{{dateSelector.availableDates}}" 
          wx:key="item" 
          bindtap="onDateSelect" 
          data-date="{{item}}">
      <text class="date-item-text">{{item}}</text>
      <text class="date-item-check" wx:if="{{dateSelector.selectedDate === item}}">âœ“</text>
    </view>
  </scroll-view>
</view>