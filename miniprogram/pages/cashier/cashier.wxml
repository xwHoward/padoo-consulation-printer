<navigation-bar title="åœºæ§æ”¶é“¶" back="{{true}}" color="black" background="#FFF"></navigation-bar>
<scroll-view class="scrollarea" scroll-y type="list">
  <view class="container">
    <!-- æ—¥æœŸé€‰æ‹© -->
    <view class="header-picker">
      <picker mode="date" value="{{selectedDate}}" bindchange="onDateChange">
        <view class="date-display">
          <text class="calendar-icon">ğŸ“…</text>
          <text class="date-text">{{selectedDate}}</text>
          <text class="arrow-down">â–¼</text>
        </view>
      </picker>
    </view>
    <!-- å‘˜å·¥æ’é’Ÿè¡¨ -->
    <view class="section timeline-section">
      <view class="section-header">
        <text class="section-title">æ’é’Ÿè¿›åº¦ (12:00 - 23:00)</text>
        <view class="reserve-btn" bindtap="openReserveModal">æ–°å¢é¢„çº¦</view>
      </view>
      <scroll-view class="timeline-scroll" scroll-x>
        <view class="timeline-container">
          <!-- æ—¶é—´è½´åˆ»åº¦ -->
          <view class="time-axis">
            <view class="time-axis-spacer"></view>
            <view class="time-mark" wx:for="{{timeLabels}}" wx:key="*this">{{item}}</view>
          </view>
          <!-- å‘˜å·¥è¡Œ -->
          <view class="staff-timeline-row" wx:for="{{staffTimeline}}" wx:key="id">
            <view class="staff-name-col">
              <text>{{item.name}}</text>
              <text class="shift-mini-tag {{item.shift}}">
                {{item.shift === 'morning' ? 'æ—©' : 'æ™š'}}
              </text>
            </view>
            <view class="timeline-track">
              <!-- èƒŒæ™¯ç½‘æ ¼çº¿ -->
              <view class="grid-line" wx:for="{{timeLabels}}" wx:key="*this"></view>
              <!-- å½“å‰æ—¶é—´çº¿ -->
              <view class="current-time-line" wx:if="{{showCurrentTimeLine}}" style="left: {{currentTimePosition}};"></view>
              <!-- å ç”¨å— -->
              <view class="time-block {{block.isReservation ? 'reservation' : ''}}" wx:for="{{item.blocks}}" wx:for-item="block" wx:key="startTime" style="left: {{block.left}}; width: {{block.width}};" bindtap="onBlockClick" data-id="{{block.id}}" data-reservation="{{block.isReservation}}">
                <view class="block-content">
                  <text class="block-customer">{{block.customerName}}</text>
                  <text class="block-time">{{block.startTime}}-{{block.endTime}}</text>
                  <text class="block-info">{{block.project}} | {{block.room}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>
    <!-- æˆ¿é—´çŠ¶æ€ -->
    <view class="section">
      <view class="section-title">æˆ¿é—´çŠ¶æ€</view>
      <view class="room-grid">
        <view class="room-item {{item.isOccupied ? 'occupied' : 'empty'}}" wx:for="{{rooms}}" wx:key="name">
          <view class="room-name">{{item.name}}</view>
          <view class="room-detail" wx:if="{{item.isOccupied}}">
            <view class="occupied-record" wx:for="{{item.occupiedRecords}}" wx:for-item="record" wx:key="endTime">
              <text class="customer-tag">{{record.customerName}}</text>
              <text class="staff-tag">{{record.technician}}</text>
              <text class="time-tag">{{record.endTime}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    <!-- å‘˜å·¥è½®æ’ -->
    <view class="section">
      <view class="section-title">ä»Šæ—¥è½®æ’</view>
      <view class="rotation-list" wx:if="{{rotationList.length > 0}}">
        <view class="rotation-item" wx:for="{{rotationList}}" wx:key="id">
          <view class="rank-num">{{index + 1}}</view>
          <view class="staff-info">
            <view class="staff-name-row">
              <text class="staff-name">{{item.name}}</text>
              <text class="shift-tag {{item.shift}}">{{item.shiftLabel}}</text>
            </view>
            <view class="available-slots" wx:if="{{item.availableSlots}}">
              <text class="slots-label">å¯çº¦:</text>
              <text class="slots-time">{{item.availableSlots}}</text>
            </view>
          </view>
          <view class="action-btns">
            <view class="btn move-up {{index === 0 ? 'disabled' : ''}}" bindtap="moveRotation" data-index="{{index}}" data-direction="up">
              <text>â†‘</text>
            </view>
            <view class="btn move-down {{index === rotationList.length - 1 ? 'disabled' : ''}}" bindtap="moveRotation" data-index="{{index}}" data-direction="down">
              <text>â†“</text>
            </view>
          </view>
        </view>
      </view>
      <view class="empty-hint" wx:else>ä»Šæ—¥æš‚æ— ä¸Šç­æ’ç­</view>
    </view>
  </view>
</scroll-view>
<!-- é¢„çº¦å¼¹çª— -->
<view class="modal-mask" wx:if="{{showReserveModal}}" bindtap="closeReserveModal">
  <view class="modal-content" catchtap="stopBubble">
    <view class="modal-header">{{reserveForm.id ? 'ç¼–è¾‘é¢„çº¦' : 'æ–°å¢é¢„çº¦'}}</view>
    <view class="modal-body">
      <view class="form-item">
        <text class="form-label">æ—¥æœŸ</text>
        <picker mode="date" value="{{reserveForm.date}}" bindchange="onReserveFieldChange" data-field="date">
          <view class="picker-val">{{reserveForm.date}}</view>
        </picker>
      </view>
      <view class="form-item combined-form-item">
        <view class="form-field">
          <text class="form-label">å§“å</text>
          <input class="form-input" placeholder="é€‰å¡«" value="{{reserveForm.customerName}}" bindinput="onReserveFieldChange" data-field="customerName" />
        </view>
        <view class="form-field">
          <gender-selector selectedGender="{{reserveForm.gender}}" bind:change="onReserveGenderChange" />
        </view>
      </view>
      <view class="form-item">
        <text class="form-label">æ‰‹æœºå·</text>
        <input class="form-input" type="number" maxlength="11" placeholder="é€‰å¡«" value="{{reserveForm.phone}}" bindinput="onReserveFieldChange" data-field="phone" />
      </view>
      <view class="form-item project-item">
        <text class="form-label">é¡¹ç›®</text>
        <project-selector selectedProject="{{reserveForm.project}}" bind:change="selectReserveProject" />
      </view>
      <view class="form-item technician-item">
        <text class="form-label">
          æŠ€å¸ˆ{{reserveForm.selectedTechnicians.length > 0 ? '(' + reserveForm.selectedTechnicians.length + ')' : ''}}
        </text>
        <technician-selector multi="{{true}}" technicianList="{{staffAvailability}}" bind:change="selectReserveTechnician" />
      </view>
      <view class="form-item">
        <text class="form-label">å¼€å§‹æ—¶é—´</text>
        <picker mode="time" value="{{reserveForm.startTime}}" bindchange="onReserveFieldChange" data-field="startTime">
          <view class="picker-val">{{reserveForm.startTime}}</view>
        </picker>
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn-cancel" bindtap="closeReserveModal">å–æ¶ˆ</button>
      <button class="btn-confirm" bindtap="confirmReserve">ç¡®å®š</button>
    </view>
  </view>
</view>
<!-- ç»“ç®—å¼¹çª— -->
<view class="modal-mask" wx:if="{{showSettlementModal}}" bindtap="closeSettlementModal">
  <view class="modal-content settlement-modal" catchtap="stopBubble">
    <view class="modal-header">ç»“ç®—</view>
    <view class="modal-body">
      <!-- æ”¯ä»˜æ–¹å¼é€‰æ‹© -->
      <view class="form-item">
        <text class="form-label">æ”¯ä»˜æ–¹å¼</text>
      </view>
      <view class="payment-methods">
        <view class="payment-item {{item.selected ? 'selected' : ''}}" wx:for="{{paymentMethods}}" wx:key="key">
          <view class="payment-header" bindtap="togglePaymentMethod" data-index="{{index}}">
            <view class="checkbox-wrapper">
              <view class="checkbox {{item.selected ? 'checked' : ''}}"></view>
              <text class="payment-label">{{item.label}}</text>
            </view>
          </view>
          <view class="payment-amount" wx:if="{{item.selected && item.key !== 'free'}}">
            <text class="amount-label">{{item.key === 'membership' ? 'æ¬¡æ•°ï¼š' : 'é‡‘é¢ï¼š'}}</text>
            <input class="amount-input" type="{{item.key === 'membership' ? 'number' : 'digit'}}" placeholder="{{item.key === 'membership' ? 'è¯·è¾“å…¥æ‰£å‡æ¬¡æ•°' : 'è¯·è¾“å…¥é‡‘é¢'}}" value="{{item.amount}}" bindinput="onPaymentAmountInput" data-index="{{index}}" />
            <text class="amount-unit">{{item.key === 'membership' ? 'æ¬¡' : 'å…ƒ'}}</text>
          </view>
        </view>
      </view>
      <!-- åˆ¸ç  -->
      <view class="form-item">
        <text class="form-label">åˆ¸ç </text>
        <input class="form-input" type="number" placeholder="é€‰å¡«" value="{{settlementCouponCode}}" bindinput="onCouponCodeInput" />
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn-cancel" bindtap="closeSettlementModal">å–æ¶ˆ</button>
      <button class="btn-confirm" bindtap="confirmSettlement">ç¡®å®š</button>
    </view>
  </view>
</view>