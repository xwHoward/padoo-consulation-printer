<navigation-bar title="åœºæ§æ”¶é“¶" back="{{true}}" color="black" background="#FFF"></navigation-bar>
<scroll-view class="scrollarea" scroll-y type="list">
  <view class="container">
    <!-- loadingé®ç½© -->
    <view class="loading-mask" wx:if="{{loading}}">
      <view class="loading-spinner"></view>
      <view class="loading-text">{{loadingText}}</view>
    </view>
    <!-- å‘˜å·¥æ’é’Ÿè¡¨ -->
    <view class="section timeline-section">
      <view class="section-header">
        <view class="section-title">æ’é’Ÿè¿›åº¦</view>
        <!-- æ—¥æœŸé€‰æ‹© -->
        <view class="header-picker">
          <picker mode="date" value="{{selectedDate}}" bindchange="onDateChange">
            <view class="date-display">
              <view class="calendar-icon">ğŸ“…</view>
              <view class="date-text">{{selectedDate}}</view>
              <view class="arrow-down">â–¼</view>
            </view>
          </picker>
        </view>
        <view class="reserve-btn" bindtap="openReserveModal">æ–°å¢é¢„çº¦</view>
      </view>
      <scroll-view class="timeline-scroll" scroll-x scroll-left="{{timelineScrollLeft}}" scroll-into-view="timeline" id="timelineScrollView">
        <view class="timeline-container" style="width: {{timeLabels.length*80}}px;">
          <!-- æ—¶é—´è½´åˆ»åº¦ -->
          <view class="time-axis">
            <view class="time-axis-spacer"></view>
            <view class="time-mark" wx:for="{{timeLabels}}" wx:key="*this">
              <text style="margin-left: -6px;">{{item}}</text>
            </view>
          </view>
          <!-- å‘˜å·¥è¡Œ -->
          <view class="staff-timeline-row" wx:for="{{staffTimeline}}" wx:key="_id">
            <view class="staff-name-col">
              <view>{{item.name}}</view>
              <view class="shift-mini-tag {{item.shift}}">
                {{item.shift === 'morning' ? 'æ—©' : 'æ™š'}}
              </view>
            </view>
            <view class="timeline-track">
              <!-- èƒŒæ™¯ç½‘æ ¼çº¿ -->
              <view class="grid-line" wx:for="{{timeLabels}}" wx:key="*this"></view>
              <!-- å½“å‰æ—¶é—´çº¿ -->
              <view class="current-time-line" wx:if="{{showCurrentTimeLine}}" style="left: {{currentTimePosition}};"></view>
              <!-- å ç”¨å— -->
              <view class="time-block {{block.isReservation ? 'reservation' : ''}} {{block.isSettled ? 'settled' : ''}}" wx:for="{{item.blocks}}" wx:for-item="block" wx:key="startTime" style="left: {{block.left}}; width: {{block.width}};" bindtap="onBlockClick" data-id="{{block._id}}" data-reservation="{{block.isReservation}}" data-settled="{{block.isSettled}}">
                <view class="block-content">
                  <view class="block-customer">{{block.customerName}} | {{block.room}}</view>
                  <view class="block-time">{{block.startTime}}-{{block.endTime}}</view>
                  <view class="block-info">{{block.project}}</view>
                </view>
              </view>
              <!-- ç©ºé—²æ—¶æ®µæ ‡è®° -->
              <view class="available-slot-label" wx:for="{{item.availableSlots}}" wx:for-item="slot" wx:key="left" style="left: {{slot.left}}; width: {{slot.width}};">
                <text class="slot-text">{{slot.displayText}}</text>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>
    <!-- æˆ¿é—´çŠ¶æ€ -->
    <view class="section">
      <view class="section-title">æˆ¿é—´çŠ¶æ€</view>
      <view class="room-grid">
        <view class="room-item {{item.isOccupied ? 'occupied' : 'empty'}}" wx:for="{{rooms}}" wx:key="name">
          <view class="room-name">{{item.name}}</view>
          <view class="room-detail" wx:if="{{item.isOccupied}}">
            <view class="occupied-record" wx:for="{{item.occupiedRecords}}" wx:for-item="record" wx:key="endTime">
              <view class="customer-tag">{{record.customerName}}</view>
              <view class="staff-tag">{{record.technician}}</view>
              <view class="time-tag">{{record.endTime}}ä¸‹</view>
            </view>
          </view>
        </view>
      </view>
    </view>
    <!-- å‘˜å·¥è½®ç‰Œ -->
    <view class="section">
      <view class="section-header">
        <view class="section-title">ä»Šæ—¥è½®ç‰Œ</view>
        <view class="push-rotation-btn" bindtap="openRotationPushModal" wx:if="{{rotationList.length > 0}}">
          æ¨é€è½®ç‰Œ
        </view>
      </view>
      <view class="rotation-list" wx:if="{{rotationList.length > 0}}">
        <view class="rotation-item" wx:for="{{rotationList}}" wx:key="_id">
          <view class="rank-num">{{index + 1}}</view>
          <view class="staff-info">
            <view class="staff-name-row">
              <view class="staff-name">{{item.name}}</view>
              <view class="shift-tag {{item.shift}}">{{item.shiftLabel}}</view>
            </view>
            <view class="available-slots" wx:if="{{item.availableSlots}}">
              <view class="slots-label">å¯çº¦:</view>
              <view class="slots-time">{{item.availableSlots}}</view>
            </view>
          </view>
          <view class="action-btns">
            <view class="btn move-up {{index === 0 ? 'disabled' : ''}}" bindtap="moveRotation" data-index="{{index}}" data-direction="up">
              <text>â†‘</text>
            </view>
            <view class="btn move-down {{index === rotationList.length - 1 ? 'disabled' : ''}}" bindtap="moveRotation" data-index="{{index}}" data-direction="down">
              <text>â†“</text>
            </view>
          </view>
        </view>
      </view>
      <view class="empty-hint" wx:else>ä»Šæ—¥æš‚æ— ä¸Šç­æ’ç­</view>
    </view>
  </view>
</scroll-view>
<!-- é¢„çº¦å¼¹çª— -->
<view class="modal-mask" wx:if="{{showReserveModal}}" bindtap="closeReserveModal">
  <view class="modal-content" catchtap="stopBubble">
    <view class="modal-header">{{reserveForm._id ? 'ç¼–è¾‘é¢„çº¦' : 'æ–°å¢é¢„çº¦'}}</view>
    <view class="modal-body">
      <view class="form-item">
        <view class="form-label">æ—¥æœŸ</view>
        <picker mode="date" value="{{reserveForm.date}}" bindchange="onReserveFieldChange" data-field="date">
          <view class="picker-val">{{reserveForm.date}}</view>
        </picker>
        <view class="form-label"></view>
        <view class="form-label">å¼€å§‹æ—¶é—´</view>
        <picker mode="time" value="{{reserveForm.startTime}}" bindchange="onReserveFieldChange" data-field="startTime">
          <view class="picker-val">{{reserveForm.startTime}}</view>
        </picker>
      </view>
      <view class="form-item combined-form-item">
        <view class="form-field">
          <view class="form-label">å§“å</view>
          <input class="form-input" placeholder="é€‰å¡«" value="{{reserveForm.customerName}}" bindinput="onReserveFieldChange" data-field="customerName" />
        </view>
        <view class="form-field">
          <gender-selector selectedGender="{{reserveForm.gender}}" bind:change="onReserveGenderChange" />
        </view>
      </view>
      <view class="form-item">
        <view class="form-label">æ‰‹æœºå·</view>
        <input class="form-input" type="number" maxlength="11" placeholder="é€‰å¡«" value="{{reserveForm.phone}}" bindinput="onReserveFieldChange" data-field="phone" />
      </view>
      <view class="customer-match-result" wx:if="{{matchedCustomer}}">
        <view class="match-info">
          <view class="match-label">åŒ¹é…é¡¾å®¢ï¼š</view>
          <view class="match-name">
            {{matchedCustomer.name}}{{matchedCustomer.gender === 'male' ? 'å…ˆç”Ÿ' : 'å¥³å£«'}}
          </view>
          <view class="match-phone">{{matchedCustomer.phone || 'æ— æ‰‹æœºå·'}}</view>
          <view class="match-tech" wx:if="{{matchedCustomer.responsibleTechnician}}">
            è´£ä»»æŠ€å¸ˆï¼š{{matchedCustomer.responsibleTechnician}}
          </view>
          <view wx:if="{{matchedCustomer.remark}}" class="match-remark">
            {{matchedCustomer.remark}}
          </view>
          <view class="match-actions">
            <view wx:if="{{!matchedCustomerApplied}}" class="match-btn apply-btn" bindtap="applyMatchedCustomer">
              åº”ç”¨
            </view>
            <view class="match-btn clear-btn" bindtap="clearMatchedCustomer">æ¸…é™¤</view>
          </view>
        </view>
      </view>
      <view class="form-item project-item">
        <view class="form-label">é¡¹ç›®</view>
        <project-selector selectedProject="{{reserveForm.project}}" bind:change="selectReserveProject" />
      </view>
      <view class="form-item technician-item">
        <view class="form-label">
          æŠ€å¸ˆ{{reserveForm.selectedTechnicians.length > 0 ? '(' + reserveForm.selectedTechnicians.length + ')' : ''}}
        </view>
        <technician-selector multi="{{true}}" technicianList="{{staffAvailability}}" showClockInBadge="{{true}}" bind:change="selectReserveTechnician" bind:toggleClockIn="toggleReserveClockIn" />
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn-cancel" bindtap="closeReserveModal">å–æ¶ˆ</button>
      <button class="btn-confirm" bindtap="confirmReserve">ç¡®å®š</button>
    </view>
  </view>
</view>
<!-- ç»“ç®—å¼¹çª— -->
<view class="modal-mask" wx:if="{{showSettlementModal}}" bindtap="closeSettlementModal">
  <view class="modal-content settlement-modal" catchtap="stopBubble">
    <view class="modal-header">ç»“ç®—</view>
    <view class="modal-body">
      <!-- é¡¹ç›®ä¿¡æ¯ -->
      <view class="project-info-section">
        <view class="info-row">
          <view class="info-label">é¡¹ç›®åŸä»·</view>
          <view class="info-value">Â¥{{projectOriginalPrice}}</view>
        </view>
        <view class="info-row total-row">
          <view class="info-label">å®æ”¶æ€»é¢</view>
          <view class="info-value total-amount">Â¥{{totalSettlementAmount}}</view>
        </view>
      </view>
      <!-- æ”¯ä»˜æ–¹å¼é€‰æ‹© -->
      <view class="form-item">
        <view class="form-label">æ”¯ä»˜æ–¹å¼</view>
      </view>
      <view class="payment-methods">
        <view class="payment-item {{item.selected ? 'selected' : ''}}" wx:for="{{paymentMethods}}" wx:key="key">
          <view class="payment-header" bindtap="togglePaymentMethod" data-index="{{index}}">
            <view class="checkbox-wrapper">
              <view class="checkbox {{item.selected ? 'checked' : ''}}"></view>
              <view class="payment-label">{{item.label}}</view>
            </view>
          </view>
          <view class="payment-amount" wx:if="{{item.selected && item.key !== 'free'}}">
            <view class="amount-label">{{item.key === 'membership' ? 'æ¬¡æ•°ï¼š' : 'é‡‘é¢ï¼š'}}</view>
            <input class="amount-input" type="{{item.key === 'membership' ? 'number' : 'digit'}}" placeholder="{{item.key === 'membership' ? 'è¯·è¾“å…¥æ‰£å‡æ¬¡æ•°' : 'è¯·è¾“å…¥é‡‘é¢'}}" value="{{item.amount}}" bindinput="onPaymentAmountInput" data-index="{{index}}" />
            <view class="amount-unit">{{item.key === 'membership' ? 'æ¬¡' : 'å…ƒ'}}</view>
          </view>
          <view class="payment-coupon" wx:if="{{item.selected && item.key !== 'free' && item.key !== 'membership'}}">
            <view class="coupon-label">åˆ¸ç ï¼š</view>
            <input class="coupon-input" type="text" placeholder="é€‰å¡«" value="{{item.couponCode}}" bindinput="onPaymentCouponCodeInput" data-index="{{index}}" />
          </view>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <view class="btn btn-cancel" bindtap="closeSettlementModal">å–æ¶ˆ</view>
      <view class="btn btn-confirm" bindtap="confirmSettlement">ç¡®å®š</view>
    </view>
  </view>
</view>
<!-- é¢„çº¦æ¨é€ç¡®è®¤å¼¹çª— -->
<view class="modal-mask" wx:if="{{pushModal.show}}" bindtap="onPushModalCancel">
  <view class="modal-content push-modal" catchtap="stopBubble">
    <view class="modal-header">{{pushModal.type === 'cancel' ? 'æ¨é€å–æ¶ˆæé†’' : 'æ¨é€é¢„çº¦æé†’'}}</view>
    <view class="modal-body">
      <view class="push-preview">
        <view class="preview-header">{{pushModal.type === 'cancel' ? 'ã€é¢„çº¦å–æ¶ˆæé†’ã€‘' : 'ã€æ–°é¢„çº¦æé†’ã€‘'}}</view>
        <view class="preview-row">
          <view class="preview-label">é¡¾å®¢ï¼š</view>
          <view class="preview-value">
            {{pushModal.reservationData.customerName}}{{pushModal.reservationData.gender === 'male' ? 'å…ˆç”Ÿ' : 'å¥³å£«'}}
          </view>
        </view>
        <view class="preview-row">
          <view class="preview-label">æ—¥æœŸï¼š</view>
          <view class="preview-value">{{pushModal.reservationData.date}}</view>
        </view>
        <view class="preview-row">
          <view class="preview-label">æ—¶é—´ï¼š</view>
          <view class="preview-value">
            {{pushModal.reservationData.startTime}} - {{pushModal.reservationData.endTime}}
          </view>
        </view>
        <view class="preview-row">
          <view class="preview-label">é¡¹ç›®ï¼š</view>
          <view class="preview-value">{{pushModal.reservationData.project}}</view>
        </view>
        <view class="preview-row">
          <view class="preview-label">æŠ€å¸ˆï¼š</view>
          <view class="preview-value">
            <block wx:for="{{pushModal.reservationData.technicians}}" wx:key="_id" wx:for-item="tech">
              {{tech.name}}{{item.phone ? '<@' + item.phone + '>' : ''}}
            </block>
          </view>
        </view>
      </view>
      <view class="push-tips">
        <text class="tips-text">â„¹ï¸ç¡®è®¤åå°†æ¨é€åˆ°ä¼ä¸šå¾®ä¿¡ç¾¤èŠå¹¶@å¯¹åº”æŠ€å¸ˆ</text>
      </view>
    </view>
    <view class="modal-footer">
      <view class="btn btn-cancel" bindtap="onPushModalCancel">å–æ¶ˆ</view>
      <view class="btn btn-confirm" bindtap="onPushModalConfirm" disabled="{{pushModal.loading}}">
        {{pushModal.loading ? 'æ¨é€ä¸­...' : 'ç¡®è®¤æ¨é€'}}
      </view>
    </view>
  </view>
</view>
<!-- è½®ç‰Œæ¨é€ç¡®è®¤å¼¹çª— -->
<view class="modal-mask" wx:if="{{rotationPushModal.show}}" bindtap="onRotationPushModalCancel">
  <view class="modal-content push-modal" catchtap="stopBubble">
    <view class="modal-header">æ¨é€ä»Šæ—¥è½®ç‰Œ</view>
    <view class="modal-body">
      <view class="push-preview">
        <view class="preview-header">ã€ä»Šæ—¥è½®ç‰Œã€‘</view>
        <view class="preview-row">
          <text class="preview-label">æ—¥æœŸï¼š</text>
          <text class="preview-value">{{selectedDate}}</text>
        </view>
        <view class="preview-row">
          <text class="preview-label">è½®ç‰Œé¡ºåºï¼š</text>
        </view>
        <block wx:for="{{rotationList}}" wx:key="_id" wx:for-index="idx">
          <view class="preview-row">
            <text class="preview-value">{{idx + 1}}. {{item.name}} ({{item.shiftLabel}})</text>
          </view>
        </block>
      </view>
    </view>
    <view class="push-tips">
      <text class="tips-text">â„¹ï¸ç¡®è®¤åå°†æ¨é€åˆ°ä¼ä¸šå¾®ä¿¡ç¾¤èŠ</text>
    </view>
    <view class="modal-footer">
      <view class="btn btn-cancel" bindtap="onRotationPushModalCancel">å–æ¶ˆ</view>
      <view class="btn btn-confirm" bindtap="onRotationPushModalConfirm" disabled="{{rotationPushModal.loading}}">
        {{rotationPushModal.loading ? 'æ¨é€ä¸­...' : 'ç¡®è®¤æ¨é€'}}
      </view>
    </view>
  </view>
</view>