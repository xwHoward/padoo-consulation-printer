<navigation-bar title="场控收银" back="{{true}}" color="black" background="#FFF">
  <view slot="right" class="landscape-btn" bindtap="toggleLandscape">
    <text>{{isLandscape ? '竖屏' : '横屏'}}</text>
  </view>
</navigation-bar>
<scroll-view class="scrollarea" scroll-y type="list">
  <view class="container">
    <!-- loading遮罩 -->
    <view class="loading-mask" wx:if="{{loading}}">
      <view class="loading-spinner"></view>
      <view class="loading-text">{{loadingText}}</view>
    </view>
    <!-- 员工排钟表 -->
    <view class="section timeline-section">
      <view class="section-header">
        <view class="section-title">排钟进度</view>
        <!-- 日期快速导航 -->
        <date-picker initialDate="{{dateSelector.selectedDate}}" bind:change="onDatePickerChange" />
        <view class="reserve-btn" wx:if="{{canCreateReservation}}" bindtap="openReserveModal">新增预约</view>
      </view>
      <timeline
        selectedDate="{{selectedDate}}"
        readonly="{{false}}"
        refreshTrigger="{{timelineRefreshTrigger}}"
        bind:blockclick="onBlockClick"
      />
    </view>
    <!-- 房间状态 -->
    <view class="section">
      <view class="section-title">房间状态</view>
      <view class="room-grid">
        <view class="room-item {{item.isOccupied ? 'occupied' : 'empty'}}" wx:for="{{rooms}}" wx:key="name">
          <view class="room-name">{{item.name}}</view>
          <view class="room-detail" wx:if="{{item.isOccupied}}">
            <view class="occupied-record" wx:for="{{item.occupiedRecords}}" wx:for-item="record" wx:key="endTime">
              <view class="customer-tag">{{record.customerName}}</view>
              <view class="staff-tag">{{record.technician}}</view>
              <view class="time-tag">{{record.endTime}}下</view>
            </view>
          </view>
        </view>
      </view>
    </view>
    <!-- 员工轮牌 -->
    <view class="section">
      <view class="section-header">
        <view class="section-title">今日轮牌</view>
        <view class="push-rotation-btn" bindtap="openRotationPushModal" wx:if="{{rotationList.length > 0 && canPushRotation}}">
          推送轮牌
        </view>
      </view>
      <view class="rotation-list" wx:if="{{rotationList.length > 0}}">
        <view class="rotation-item" wx:for="{{rotationList}}" wx:key="_id">
          <view class="rank-num">{{index + 1}}</view>
          <view class="staff-info">
            <view class="staff-name-row">
              <view class="staff-name">{{item.name}}</view>
              <view class="shift-tag {{item.shift}}">{{item.shift === 'morning' ? '早班' : '晚班'}}</view>
            </view>
            <view class="available-slots" wx:if="{{item.availableSlots}}">
              <view class="slots-label">可约:</view>
              <view class="slots-time">{{item.availableSlots}}</view>
            </view>
          </view>
          <view class="action-btns" wx:if="{{canPushRotation}}">
            <view class="btn move-up {{index === 0 ? 'disabled' : ''}}" bindtap="moveRotation" data-index="{{index}}" data-direction="up">
              <text>↑</text>
            </view>
            <view class="btn move-down {{index === rotationList.length - 1 ? 'disabled' : ''}}" bindtap="moveRotation" data-index="{{index}}" data-direction="down">
              <text>↓</text>
            </view>
          </view>
        </view>
      </view>
      <view class="empty-hint" wx:else>今日暂无上班排班</view>
    </view>
  </view>
</scroll-view>
<!-- 预约弹窗 -->
<view class="modal-mask" wx:if="{{showReserveModal}}" bindtap="closeReserveModal">
  <view class="modal-content" catchtap="stopBubble">
    <view class="modal-header">{{reserveForm._id ? '编辑预约' : '新增预约'}}</view>
    <view class="modal-body">
      <view class="form-item">
        <view class="form-label">日期</view>
        <picker mode="date" value="{{reserveForm.date}}" bindchange="onReserveFieldChange" data-field="date">
          <view class="picker-val">{{reserveForm.date}}</view>
        </picker>
        <view class="form-label"></view>
        <view class="form-label">开始时间</view>
        <picker mode="time" value="{{reserveForm.startTime}}" bindchange="onReserveFieldChange" data-field="startTime">
          <view class="picker-val">{{reserveForm.startTime}}</view>
        </picker>
      </view>
      <view class="form-item combined-form-item">
        <view class="form-field">
          <view class="form-label">姓名</view>
          <input class="form-input" placeholder="选填" value="{{reserveForm.customerName}}" bindinput="onReserveFieldChange" data-field="customerName" />
        </view>
        <view class="form-field">
          <gender-selector selectedGender="{{reserveForm.gender}}" bind:change="onReserveGenderChange" />
        </view>
      </view>
      <view class="form-item">
        <view class="form-label">手机号</view>
        <input class="form-input" type="number" maxlength="11" placeholder="选填" value="{{reserveForm.phone}}" bindinput="onReserveFieldChange" data-field="phone" />
      </view>
      <view class="customer-match-result" wx:if="{{matchedCustomer}}">
        <view class="match-info">
          <view class="match-label">匹配顾客：</view>
          <view class="match-name">
            {{matchedCustomer.name}}{{matchedCustomer.gender === 'male' ? '先生' : '女士'}}
          </view>
          <view class="match-phone">{{matchedCustomer.phone || '无手机号'}}</view>
          <view class="match-tech" wx:if="{{matchedCustomer.responsibleTechnician}}">
            责任技师：{{matchedCustomer.responsibleTechnician}}
          </view>
          <view wx:if="{{matchedCustomer.remark}}" class="match-remark">
            {{matchedCustomer.remark}}
          </view>
          <view class="match-actions">
            <view wx:if="{{!matchedCustomerApplied}}" class="match-btn apply-btn" bindtap="applyMatchedCustomer">
              应用
            </view>
            <view class="match-btn clear-btn" bindtap="clearMatchedCustomer">清除</view>
          </view>
        </view>
      </view>
      <view class="form-item project-item">
        <view class="form-label">项目</view>
        <project-selector selectedProject="{{reserveForm.project}}" bind:change="selectReserveProject" />
      </view>
      <view class="form-item technician-item">
        <view class="form-label">
          技师{{reserveForm.selectedTechnicians.length > 0 ? '(' + reserveForm.selectedTechnicians.length + ')' : ''}}
        </view>
        <technician-selector multi="{{true}}" technicianList="{{staffAvailability}}" showClockInBadge="{{true}}" bind:change="selectReserveTechnician" bind:toggleClockIn="toggleReserveClockIn" />
      </view>
    </view>
    <view class="modal-footer">
      <button class="btn-cancel" bindtap="closeReserveModal">取消</button>
      <button class="btn-confirm" bindtap="confirmReserve">确定</button>
    </view>
  </view>
</view>
<!-- 结算弹窗 -->
<view class="modal-mask" wx:if="{{showSettlementModal}}" bindtap="closeSettlementModal">
  <view class="modal-content settlement-modal" catchtap="stopBubble">
    <view class="modal-header">结算</view>
    <view class="modal-body">
      <!-- 项目信息 -->
      <view class="project-info-section">
        <view class="info-row">
          <view class="info-label">项目原价</view>
          <view class="info-value">¥{{projectOriginalPrice}}</view>
        </view>
        <view class="info-row total-row">
          <view class="info-label">实收总额</view>
          <view class="info-value total-amount">¥{{totalSettlementAmount}}</view>
        </view>
      </view>
      <!-- 支付方式选择 -->
      <view class="form-item">
        <view class="form-label">支付方式</view>
      </view>
      <view class="payment-methods">
        <view class="payment-item {{item.selected ? 'selected' : ''}}" wx:for="{{paymentMethods}}" wx:key="key">
          <view class="payment-header" bindtap="togglePaymentMethod" data-index="{{index}}">
            <view class="checkbox-wrapper">
              <view class="checkbox {{item.selected ? 'checked' : ''}}"></view>
              <view class="payment-label">{{item.label}}</view>
            </view>
          </view>
          <view class="payment-amount" wx:if="{{item.selected && item.key !== 'free'}}">
            <view class="amount-label">{{item.key === 'membership' ? '次数：' : '金额：'}}</view>
            <input class="amount-input" type="{{item.key === 'membership' ? 'number' : 'digit'}}" placeholder="{{item.key === 'membership' ? '请输入扣减次数' : '请输入金额'}}" value="{{item.amount}}" bindinput="onPaymentAmountInput" data-index="{{index}}" />
            <view class="amount-unit">{{item.key === 'membership' ? '次' : '元'}}</view>
          </view>
          <view class="payment-coupon" wx:if="{{item.selected && item.key !== 'free' && item.key !== 'membership'}}">
            <view class="coupon-label">券码：</view>
            <input class="coupon-input" type="text" placeholder="选填" value="{{item.couponCode}}" bindinput="onPaymentCouponCodeInput" data-index="{{index}}" />
          </view>
        </view>
      </view>
    </view>
    <view class="modal-footer">
      <view class="btn btn-cancel" bindtap="closeSettlementModal">取消</view>
      <view class="btn btn-confirm" bindtap="confirmSettlement">确定</view>
    </view>
  </view>
</view>
<!-- 预约推送确认弹窗 -->
<view class="modal-mask" wx:if="{{pushModal.show}}" bindtap="onPushModalCancel">
  <view class="modal-content push-modal" catchtap="stopBubble">
    <view class="modal-header">{{pushModal.type === 'cancel' ? '推送取消提醒' : '推送预约提醒'}}</view>
    <view class="modal-body">
      <view class="push-preview">
        <view class="preview-header">{{pushModal.type === 'cancel' ? '【预约取消提醒】' : '【新预约提醒】'}}</view>
        <view class="preview-row">
          <view class="preview-label">顾客：</view>
          <view class="preview-value">
            {{pushModal.reservationData.customerName}}{{pushModal.reservationData.gender === 'male' ? '先生' : '女士'}}
          </view>
        </view>
        <view class="preview-row">
          <view class="preview-label">日期：</view>
          <view class="preview-value">{{pushModal.reservationData.date}}</view>
        </view>
        <view class="preview-row">
          <view class="preview-label">时间：</view>
          <view class="preview-value">
            {{pushModal.reservationData.startTime}} - {{pushModal.reservationData.endTime}}
          </view>
        </view>
        <view class="preview-row">
          <view class="preview-label">项目：</view>
          <view class="preview-value">{{pushModal.reservationData.project}}</view>
        </view>
        <view class="preview-row">
          <view class="preview-label">技师：</view>
          <view class="preview-value">
            <text wx:for="{{pushModal.reservationData.technicians}}" wx:key="_id" wx:for-item="tech">
              {{tech.name}}{{tech.phone ? '<@' + tech.phone + '>' : ''}}{{tech.isClockIn ? '[点]' : ''}}
            </text>
          </view>
        </view>
      </view>
      <view class="push-tips">
        <text class="tips-text">ℹ️确认后将推送到企业微信群聊并@对应技师</text>
      </view>
    </view>
    <view class="modal-footer">
      <view class="btn btn-cancel" bindtap="onPushModalCancel">取消</view>
      <view class="btn btn-confirm" bindtap="onPushModalConfirm" disabled="{{pushModal.loading}}">
        {{pushModal.loading ? '推送中...' : '确认推送'}}
      </view>
    </view>
  </view>
</view>
<!-- 轮牌推送确认弹窗 -->
<view class="modal-mask" wx:if="{{rotationPushModal.show}}" bindtap="onRotationPushModalCancel">
  <view class="modal-content push-modal" catchtap="stopBubble">
    <view class="modal-header">推送今日轮牌</view>
    <view class="modal-body">
      <view class="push-preview">
        <view class="preview-header">【今日轮牌】</view>
        <view class="preview-row">
          <text class="preview-label">日期：</text>
          <text class="preview-value">{{selectedDate}}</text>
        </view>
        <view class="preview-row">
          <text class="preview-label">轮牌顺序：</text>
        </view>
        <block wx:for="{{rotationList}}" wx:key="_id" wx:for-index="idx">
          <view class="preview-row">
            <text class="preview-value">{{idx + 1}}. {{item.name}} ({{item.shift === 'morning' ? '早班' : '晚班'}})</text>
          </view>
        </block>
      </view>
    </view>
    <view class="push-tips">
      <text class="tips-text">ℹ️确认后将推送到企业微信群聊</text>
    </view>
    <view class="modal-footer">
      <view class="btn btn-cancel" bindtap="onRotationPushModalCancel">取消</view>
      <view class="btn btn-confirm" bindtap="onRotationPushModalConfirm" disabled="{{rotationPushModal.loading}}">
        {{rotationPushModal.loading ? '推送中...' : '确认推送'}}
      </view>
    </view>
  </view>
</view>