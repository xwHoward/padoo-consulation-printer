<navigation-bar title="é¡¾å®¢ç®¡ç†" back="{{true}}" color="black" background="#FFF">
  <view slot="right" class="nav-btns">
    <view bindtap="showAddCustomer" class="nav-btn" aria-role="button" aria-label="æ–°å¢é¡¾å®¢">
      <text class="nav-btn-text">æ–°å¢é¡¾å®¢</text>
    </view>
  </view>
</navigation-bar>
<view class="customers-page">
  <view class="customer-list">
    <view wx:for="{{customerList}}" wx:key="phone" class="customer-card">
      <view class="customer-header">
        <view class="customer-info">
          <view class="customer-name">{{item.name}}{{item.gender === 'male' ? 'å…ˆç”Ÿ' : 'å¥³å£«'}}</view>
          <view wx:if="{{item.phone}}" class="customer-phone">{{item.phone}}</view>
          <view class="customer-meta">
            <view wx:if="{{item.responsibleTechnician}}" class="meta-item">
              <text class="meta-label">è´£ä»»æŠ€å¸ˆ:</text>
              <text>{{item.responsibleTechnician}}</text>
            </view>
            <view wx:if="{{item.licensePlate}}" class="meta-item">
              <text class="meta-label">è½¦ç‰Œå·:</text>
              <text>{{item.licensePlate}}</text>
            </view>
          </view>
        </view>
        <view class="action-buttons">
          <view class="action-btn open-card" catch:tap="showOpenCardModal" data-customer="{{item}}">
            å¼€å¡
          </view>
          <view class="action-btn edit" catch:tap="showEditCustomer" data-customer="{{item}}">
            ç¼–è¾‘
          </view>
          <view class="action-btn detail" catch:tap="loadCustomerVisits" data-customer="{{item}}">
            è¯¦æƒ…
          </view>
        </view>
      </view>
      <view wx:if="{{item.remarks}}" class="customer-remarks">
        <text class="meta-label">å¤‡æ³¨:</text>
        {{item.remarks}}
      </view>
    </view>
  </view>
  <view wx:if="{{customerList.length === 0}}" class="empty-state">
    <view class="empty-icon">ğŸ“‹</view>
    <view class="empty-text">æš‚æ— é¡¾å®¢è®°å½•</view>
  </view>
</view>
<view class="modal-mask" wx:if="{{showEditModal}}" bindtap="onModalCancel"></view>
<view class="modal-container" wx:if="{{showEditModal}}">
  <view class="modal-title">{{modalTitle}}</view>
  <view class="form-group">
    <text class="form-label">æ‰‹æœºå·</text>
    <input class="form-input" type="number" placeholder="é€‰å¡«" maxlength="11" bindinput="onPhoneInput" value="{{formPhone}}" />
  </view>
  <view class="form-group">
    <text class="form-label">å§“å</text>
    <input class="form-input" type="text" placeholder="é€‰å¡«" bindinput="onNameInput" value="{{formName}}" />
  </view>
  <view class="form-group">
    <text class="form-label">è´£ä»»æŠ€å¸ˆ</text>
    <view class="technician-selector">
      <label wx:for="{{technicianList}}" wx:key="id" wx:for-item="tech" class="technician-option {{formResponsibleTechnician === tech.name ? 'selected' : ''}}" bindtap="onTechnicianSelect" data-technician="{{tech.name}}">
        <radio value="{{tech.name}}" checked="{{formResponsibleTechnician === tech.name}}" />
        <text>{{tech.name}}</text>
      </label>
    </view>
  </view>
  <view class="form-group">
    <text class="form-label">è½¦ç‰Œå·</text>
    <input class="form-input" type="text" placeholder="é€‰å¡«" bindinput="onLicensePlateInput" value="{{formLicensePlate}}" />
  </view>
  <view class="form-group">
    <text class="form-label">å¤‡æ³¨</text>
     <input class="form-input" type="text" placeholder="é€‰å¡«" bindinput="onRemarksInput" value="{{formRemarks}}" />
  </view>
  <view class="modal-footer">
    <view class="modal-btn cancel-btn" bindtap="onModalCancel">å–æ¶ˆ</view>
    <view class="modal-btn confirm-btn" bindtap="onModalConfirm">ç¡®å®š</view>
  </view>
</view>
<view class="modal-mask" wx:if="{{showOpenCardModal}}" bindtap="onOpenCardCancel"></view>
<view class="modal-container large" wx:if="{{showOpenCardModal}}">
  <view class="modal-title">å¼€å¡</view>
  <view class="customer-info-display">
    <view class="info-row">
      <text class="info-label">é¡¾å®¢:</text>
      <text class="info-value">{{selectedCustomerForCard.name}}</text>
    </view>
    <view wx:if="{{selectedCustomerForCard.phone}}" class="info-row">
      <text class="info-label">æ‰‹æœºå·:</text>
      <text class="info-value">{{selectedCustomerForCard.phone}}</text>
    </view>
  </view>
  <view class="form-group">
    <text class="form-label">é€‰æ‹©ä¼šå‘˜å¡</text>
    <view class="membership-card-selector">
      <label wx:for="{{membershipCards}}" wx:key="id" wx:for-item="card" class="card-option {{selectedCardId === card.id ? 'selected' : ''}}" bindtap="onCardSelect" data-card="{{card}}">
        <radio value="{{card.id}}" checked="{{selectedCardId === card.id}}" />
        <view class="card-option-content">
          <view class="card-option-name">{{card.name}}</view>
          <view class="card-option-meta">
            <text class="meta-text">{{card.project}}</text>
            <text class="meta-text">{{card.remainingTimes}}æ¬¡</text>
            <text class="meta-text">Â¥{{card.originalPrice}}</text>
          </view>
        </view>
      </label>
    </view>
  </view>
  <view wx:if="{{selectedCardInfo}}" class="selected-card-info">
    <view class="info-row">
      <text class="info-label">ä¼šå‘˜å¡:</text>
      <text class="info-value">{{selectedCardInfo.name}}</text>
    </view>
    <view class="info-row">
      <text class="info-label">åŸä»·:</text>
      <text class="info-value">Â¥{{selectedCardInfo.originalPrice}}</text>
    </view>
    <view class="info-row">
      <text class="info-label">æ¬¡æ•°:</text>
      <text class="info-value">{{selectedCardInfo.remainingTimes}}æ¬¡</text>
    </view>
    <view class="info-row">
      <text class="info-label">é¡¹ç›®:</text>
      <text class="info-value">{{selectedCardInfo.project}}</text>
    </view>
  </view>
  <view class="form-group">
    <text class="form-label">å®ä»˜é‡‘é¢</text>
    <input class="form-input" type="digit" placeholder="è¯·è¾“å…¥å®ä»˜é‡‘é¢" bindinput="onPaidAmountInput" value="{{formPaidAmount}}" />
  </view>
  <view class="form-group">
    <text class="form-label">é”€å”®å‘˜å·¥</text>
    <view class="technician-selector">
      <label wx:for="{{technicianList}}" wx:key="id" wx:for-item="tech" class="technician-option {{formSalesStaff === tech.name ? 'selected' : ''}}" bindtap="onSalesStaffSelect" data-staff="{{tech.name}}">
        <radio value="{{tech.name}}" checked="{{formSalesStaff === tech.name}}" />
        <text>{{tech.name}}</text>
      </label>
    </view>
  </view>
  <view class="form-group">
    <text class="form-label">å¤‡æ³¨</text>
    <input class="form-input" placeholder="é€‰å¡«" bindinput="onCardRemarksInput" value="{{formCardRemarks}}" />
  </view>
  <view class="modal-footer">
    <view class="modal-btn cancel-btn" bindtap="onOpenCardCancel">å–æ¶ˆ</view>
    <view class="modal-btn confirm-btn" bindtap="onOpenCardConfirm">ç¡®å®š</view>
  </view>
</view>
<view class="modal-mask" wx:if="{{showDetailModal}}" bindtap="closeDetailModal"></view>
<view class="detail-modal-container" wx:if="{{showDetailModal}}">
  <view class="detail-header">
    <view class="detail-title">é¡¾å®¢è¯¦æƒ…</view>
    <view class="detail-close" bindtap="closeDetailModal">Ã—</view>
  </view>
  <view class="detail-content">
    <view class="detail-info">
      <view class="detail-row">
        <text class="detail-label">å§“å:</text>
        <text class="detail-value">{{selectedCustomer.name}}</text>
      </view>
      <view wx:if="{{selectedCustomer.phone}}" class="detail-row">
        <text class="detail-label">æ‰‹æœºå·:</text>
        <text class="detail-value">{{selectedCustomer.phone}}</text>
      </view>
      <view wx:if="{{selectedCustomer.responsibleTechnician}}" class="detail-row">
        <text class="detail-label">è´£ä»»æŠ€å¸ˆ:</text>
        <text class="detail-value">{{selectedCustomer.responsibleTechnician}}</text>
      </view>
      <view wx:if="{{selectedCustomer.licensePlate}}" class="detail-row">
        <text class="detail-label">è½¦ç‰Œå·:</text>
        <text class="detail-value">{{selectedCustomer.licensePlate}}</text>
      </view>
      <view wx:if="{{selectedCustomer.remarks}}" class="detail-row">
        <text class="detail-label">å¤‡æ³¨:</text>
        <text class="detail-value">{{selectedCustomer.remarks}}</text>
      </view>
    </view>
    <view class="membership-cards-section">
      <view class="history-title">ä¼šå‘˜å¡</view>
      <view wx:if="{{customerMemberships.length === 0}}" class="empty-history">æš‚æ— ä¼šå‘˜å¡</view>
      <view wx:else class="membership-cards-list">
        <view wx:for="{{customerMemberships}}" wx:key="id" class="membership-card-item {{item.status === 'disabled' ? 'disabled' : ''}}">
          <view class="card-header">
            <view class="card-name">{{item.cardName}}</view>
            <view class="card-status {{item.status === 'active' ? 'active' : 'disabled'}}">
              {{item.status === 'active' ? 'å¯ç”¨' : 'ç¦ç”¨'}}
            </view>
          </view>
          <view class="card-body">
            <view class="card-row">
              <text class="card-label">é¡¹ç›®:</text>
              <text class="card-value">{{item.project}}</text>
            </view>
            <view class="card-row">
              <text class="card-label">å‰©ä½™æ¬¡æ•°:</text>
              <text class="card-value highlight">{{item.remainingTimes}}æ¬¡</text>
            </view>
            <view class="card-row">
              <text class="card-label">åŸä»·:</text>
              <text class="card-value">Â¥{{item.originalPrice}}</text>
            </view>
            <view class="card-row">
              <text class="card-label">å®ä»˜:</text>
              <text class="card-value">Â¥{{item.paidAmount}}</text>
            </view>
            <view class="card-row">
              <text class="card-label">é”€å”®:</text>
              <text class="card-value">{{item.salesStaff}}</text>
            </view>
            <view wx:if="{{item.remarks}}" class="card-row">
              <text class="card-label">å¤‡æ³¨:</text>
              <text class="card-value">{{item.remarks}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
    <view class="visit-history">
      <view class="history-title">æ¶ˆè´¹è®°å½•</view>
      <view wx:if="{{visitRecords.length === 0}}" class="empty-history">æš‚æ— æ¶ˆè´¹è®°å½•</view>
      <view wx:else class="history-list">
        <view wx:for="{{visitRecords}}" wx:key="id" wx:for-index="visitIndex" class="history-item">
          <view class="history-header">
            <view class="history-date">{{item.date}}</view>
          </view>
          <view class="history-body" bindtap="goToConsultationDetail">
            <view class="history-details">
              <view class="history-detail">
                <text class="detail-label">é¡¹ç›®:</text>
                <text>{{item.project}}</text>
              </view>
              <view class="history-detail">
                <text class="detail-label">æŠ€å¸ˆ:</text>
                <text>{{item.technician}}</text>
              </view>
              <view class="history-detail">
                <text class="detail-label">æˆ¿é—´:</text>
                <text>{{item.room}}</text>
              </view>
              <view wx:if="{{item.isClockIn}}" class="history-tag clock-in">ç‚¹é’Ÿ</view>
            </view>
            <view class="view-detail-hint">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…</view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>